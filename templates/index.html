<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AMA Timesheet Summarizer</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='ama_logo.png')}}" > 

  <style>
    :root {
      --accent: #a3161c;
      --accent-dark: #700f14;
    }

    body {
      /* include padding in the height calculation so 100vh doesn't overflow */
      box-sizing: border-box;
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      background-image: url("{{ url_for('static', filename='sexy.jpg') }}");
      background-repeat: no-repeat;
      /* background-size: cover; */
      background-size: 120% auto; /* stretch to full width, auto height */
      background-position: 30% 87%;
      display: flex;
      justify-content: center;
      /* move content closer to the bottom */
      align-items: flex-end;
      /* add some breathing room from the bottom edge; tweak as needed (e.g. 6vh, 10vh) */
      padding-bottom: 10vh;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: white;
      padding: 50px;
      border: 2px solid #173872; /* container border changed per request */
      border-radius: 5px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    h1 {
      color: #173872;
      margin: 0; /* keep title vertically aligned with the logo */
    }
    input[type="file"] {
      margin: 15px 0;
    }
    input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 8px;
      accent-color: var(--accent);
    }
    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background: var(--accent-dark);
    }
    /* header row: logo left, title right */
    .header {
      display: flex;
      align-items: center;
      justify-content: center; /* keep the pair centered in the card */
      gap: 12px;
      margin-bottom: 8px;
    }
    .logo {
      width: 50px; /* smaller logo */
      height: auto;
      margin-bottom: 0;
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="{{ url_for('static', filename='ama_logo.png') }}" alt="AMA logo" class="logo">
      <h1>Combined Daily Report</h1>
    </div>
    <p>Upload an Excel workbook that contains both required sheets.</p>
    <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data">
      <input id="workbook-input" type="file" name="workbook" accept=".xlsx,.xls,.xlsm,.xlsb" required><br><br>
      <label style="display:inline-flex; align-items:center; gap:8px; font-size:0.95rem;">
        <input id="per-sheet" type="checkbox" name="per_sheet" checked>
        Write each Job to its own sheet as well
      </label>
      <br><br>
      <button id="submit-btn" type="submit">Generate Combined Report</button>
    </form>
    <div id="status" style="margin-top:12px;color:#173872;"></div>

    <script>
      // AJAX submit that keeps user on the same page and triggers the
      // browser's download using a returned download_url.
      const form = document.getElementById('upload-form');
      const status = document.getElementById('status');
      const submitBtn = document.getElementById('submit-btn');

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const fileInput = document.getElementById('workbook-input');
        if (!fileInput.files.length) return;
        submitBtn.disabled = true;
        status.textContent = 'Uploading & processing...';

        const fd = new FormData(form);
        try {
          const res = await fetch(form.action, {
            method: 'POST',
            body: fd,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          // Try to parse JSON response (contains download_url) when successful
          // Read the body exactly once to avoid "body stream already read" errors.
          const bodyText = await res.text();
          if (res.ok) {
            // Try to parse JSON from the text; fall back to using the text directly.
            try {
              const data = JSON.parse(bodyText);
              if (data && data.download_url) {
                status.textContent = 'Ready — starting browser download...';
                window.location = data.download_url;
                setTimeout(() => {
                  submitBtn.disabled = false;
                  status.textContent = 'Done. You can upload another file.';
                  form.reset();
                }, 1500);
                return;
              }
            } catch (err) {
              // bodyText isn't JSON — treat it as a success message
              status.textContent = bodyText || 'Done.';
              submitBtn.disabled = false;
              form.reset();
              return;
            }
            // If it was JSON but didn't contain download_url, show raw text
            status.textContent = bodyText || 'Done.';
            submitBtn.disabled = false;
            form.reset();
            return;
          } else {
            // Non-OK status: show the server response text as an error
            status.textContent = 'Server error: ' + (bodyText || res.statusText || res.status);
          }
        } catch (err) {
          status.textContent = 'Upload failed: ' + err.message;
        } finally {
          submitBtn.disabled = false;
        }
      });
    </script>
  </div>
</body>
</html>
